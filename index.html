<!DOCTYPE html>

<html>
<body style="margin: 0; padding: 0; background-color: black;">
  <canvas id="myCanvas"></canvas>
  <audio id="myAudio" ></audio>

<script>
document.body.scrollTop = 0; // <-- pull the page to the top
document.body.style.overflow = 'hidden'; // <-- To hide scrollbar

var canvas = document.getElementById('myCanvas');
var ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

var dataArray;
var analyser;

//========Settings========
var fftSize = 4096;      //how many samples to take for a Fast Fourier Transform
var startOffset = 20;    //anything below 20 Hz is inaudible
var endCutoff = Math.floor(fftSize/2.25);  //cutoff high frequencies not usually used in music
var freqInc = 1;         //How much to increment each loop used to skip over some frequencies in dataArray (if freqInc != 1)
//========================

function draw(){
  //analyser.getByteTimeDomainData(dataArray);
  analyser.getByteFrequencyData(dataArray);
  //https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/getByteFrequencyData
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  //console.log(dataArray[dataArray.length/2]);

  for(var i = startOffset; i<dataArray.length-endCutoff; i += freqInc){

      if(dataArray[i] == 255){
        console.log("max decibels reached " + i);
      }
      ctx.fillStyle = "#"+i +""+i+""+i;
      ctx.fillRect((i-startOffset) * (canvas.width/(dataArray.length-endCutoff-startOffset)), (dataArray[i] / 128.0 * canvas.height / 2) *-1 + canvas.height-1 , 2, canvas.height);

  }

  requestAnimationFrame(draw);
}



navigator.mediaDevices.getDisplayMedia({video: true, audio: true}).then(function(stream){
  audioStreams = stream.getAudioTracks();
  console.log(audioStreams);
  //document.getElementById("myAudio").srcObject = stream;

  var audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.minDecibels = -90;  //default -100
  analyser.maxDecibels = -10;  //default -30
  analyser.smoothingTimeConstant = 0.85;  //default 0.8
  analyser.fftSize = fftSize;  //default 2048

  var bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  console.log(dataArray.length);

  audioSource = audioCtx.createMediaStreamSource(stream);

  audioSource.connect(analyser);
  //analyser.connect(audioCtx.destination);

  requestAnimationFrame(draw);
});

window.addEventListener("resize", function(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
})




</script>
</body>
</html>
